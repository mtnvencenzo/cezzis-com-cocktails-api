name: cezzis
services:
  cocktails-api:
    image: acrveceusgloshared001.azurecr.io/cocktailsapi:latest
    container_name: cocktails-api
    ports:
      - "7177:7177"
      - "7176:7176"
    environment:
      - ASPNETCORE_ENVIRONMENT=docker
      - ASPNETCORE_HTTPS_PORTS=7176
      - ASPNETCORE_URLS=http://0.0.0.0:7177;https://0.0.0.0:7176
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/cocktails-api.pfx
      - CosmosDb__CocktailsContainerName=cezzis-docker-cocktails-cocktail
      - CosmosDb__IngredientsContainerName=cezzis-docker-cocktails-ingredient
      - CosmosDb__AccountsContainerName=cezzis-docker-accounts-account
      - LocalhostImages__Enabled=true
      - LocalhostImages__Path=/data/cocktail/images/
    volumes:
      - "$PWD/.certs/cocktails-api:/https:ro"
      - "/home/mtnvencenzo/Github/cezzis-com-cocktails-images/Images/Main:/data/cocktail/images:ro"
    entrypoint: >
      sh -c "
        if [ -f /https/azurite.crt ]; then
          cp /https/azurite.crt /usr/local/share/ca-certificates/ &&
          update-ca-certificates
        fi &&
        if [ -f /https/otel-collector.crt ]; then
          cp /https/otel-collector.crt /usr/local/share/ca-certificates/ &&
          update-ca-certificates
        fi &&
        exec dotnet Cocktails.Api.dll
      "
    networks:
      - cezzis-network
      - elastic-stack_elastic-network
      - azure-stack_azure-network
    depends_on:
      - dapr-sidecar-cocktails-api

  dapr-sidecar-cocktails-api:
    image: daprio/daprd:latest
    container_name: dapr-sidecar-cocktails-api
    ports:
      - "3500:3500"
      - "50001:50001"
    environment:
      - SSL_CERT_DIR=/certs
    command: >
      ./daprd
        --app-id cocktails-api
        --app-port 7176
        --app-protocol https
        --dapr-http-port 3500
        --dapr-grpc-port 50001
        --components-path /components
        --enable-metrics false
        --enable-api-logging false
        --placement-host-address ''
        --scheduler-host-address ''
        --app-channel-address cocktails-api
    volumes:
      - ./.dapr/docker:/components
      - "$PWD/.certs/dapr-sidecar-cocktails-api:/certs:ro"
    networks:
      - cezzis-network
      - redis-stack_redis-network
      - azure-stack_azure-network

  cocktails-web:
    image: acrveceusgloshared001.azurecr.io/cocktailsweb:latest
    container_name: cocktails-web
    ports:
      - "4000:80"
      - "4001:443"
    environment:
      - VITE_NODE_ENV=docker
      - VITE_PORT=4001
      - VITE_TELEMETRY_URL=https://localhost:50052
      - VITE_AUTH0_DOMAIN=login.cezzis.com
      - VITE_AUTH0_CLIENT_ID=HZXyiZxjHgkQqeb6UJxmikCGYpSz5iPb
      - VITE_AUTH0_REDIRECT_URI=https://localhost:4001/iam/auth/redirect/
      - VITE_AUTH0_COCKTAILS_API_AUDIENCE=https://cezzis-cocktails-api
      - VITE_COCKTAILS_API_URL=https://localhost:7176
      - VITE_COCKTAILS_IMAGE_URL=https://localhost:7176/api/v1/images
    volumes:
      - "$HOME/Github/cezzis-com-cocktails-web/cocktails.web/.certs:/etc/nginx/certs:ro"
    networks:
      - cezzis-network
    depends_on:
      - cocktails-api


networks:
  cezzis-network:
    driver: bridge
  
  azure-stack_azure-network:
    external: true
    name: azure-stack_azure-network

  redis-stack_redis-network:
    external: true
    name: redis-stack_redis-network

  kafka-stack_kafka-stack:
    external: true
    
  elastic-stack_elastic-network:
    external: true
    name: elastic-stack_elastic-network
