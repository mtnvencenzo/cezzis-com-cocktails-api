name: cezzis
services:
  cocktails-api:
    hostname: cocktails-api.docker.local
    container_name: cocktails-api
    image: acrveceusgloshared001.azurecr.io/cocktailsapi:latest
    restart: unless-stopped
    ports:
      - "7177:7177"
      - "7176:7176"
    environment:
      - SEED_ON_STARTUP=true
      - ASPNETCORE_ENVIRONMENT=docker
      - ASPNETCORE_HTTPS_PORTS=7176
      - ASPNETCORE_URLS=http://0.0.0.0:7177;https://0.0.0.0:7176
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/docker-local.pfx
      - Kafka__BootstrapServers=kafka-broker-1.docker.local:19093
      - Kafka__SslCaLocation=/https/docker-local.crt
      - LocalhostImages__Enabled=true
      - LocalhostImages__Path=/data/cocktail/images/
    volumes:
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/docker-local}/docker-local.pfx:/https/docker-local.pfx:ro"
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/docker-local}/docker-local.crt:/https/docker-local.crt:ro"
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/azurite-local}/azurite-local.crt:/https/azurite-local.crt:ro"
      - /home/mtnvencenzo/Github/cezzis-com-cocktails-images/Images/Main:/data/cocktail/images:ro
    entrypoint: >
      sh -c "
        if ls /https/*.crt 1> /dev/null 2>&1; then
          cp /https/*.crt /usr/local/share/ca-certificates/ &&
          update-ca-certificates
        fi &&
        exec dotnet Cocktails.Api.dll
      "
    networks:
      cezzis-network:
        aliases:
          - cocktails-api.docker.local
      elastic-stack_elastic-network:
      azure-stack_azure-network:
      kafka-stack_kafka-network:
    depends_on:
      - dapr-sidecar-cocktails-api

  cocktails-web:
    hostname: cocktails-web.docker.local
    container_name: cocktails-web
    image: acrveceusgloshared001.azurecr.io/cocktailsweb:latest
    restart: unless-stopped
    ports:
      - "4000:80"
      - "4001:443"
    environment:
      - VITE_NODE_ENV=docker
      - VITE_PORT=4001
      - VITE_TELEMETRY_URL=https://localhost:50052
      - VITE_AUTH0_DOMAIN=login.cezzis.com
      - VITE_AUTH0_CLIENT_ID=HZXyiZxjHgkQqeb6UJxmikCGYpSz5iPb
      - VITE_AUTH0_REDIRECT_URI=https://localhost:4001/iam/auth/redirect/
      - VITE_AUTH0_COCKTAILS_API_AUDIENCE=https://cezzis-cocktails-api
      - VITE_COCKTAILS_API_URL=https://localhost:7176
      - VITE_COCKTAILS_IMAGE_URL=https://localhost:7176/api/v1/images
    volumes:
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/docker-local}:/etc/nginx/certs:ro"
    networks:
      cezzis-network:
        aliases:
          - cocktails-web.docker.local

  cocktails-mcp:
    hostname: cocktails-mcp.docker.local
    container_name: cocktails-mcp
    image: acrveceusgloshared001.azurecr.io/cocktailsmcp:latest
    restart: unless-stopped
    ports:
      - "7999:7999"
    environment:
      - ENV=docker
      - PORT=7999
      - AUTH0_AUDIENCE=https://cezzis-cocktails-api
      - AUTH0_CLIENT_ID=6pNnUIHVbyakv27TtICiLyAQbXYxNjOQ
      - AUTH0_DOMAIN=login.cezzis.com
      - AUTH0_SCOPES="openid offline_access profile email read:owned-account write:owned-account"
      - COCKTAILS_API_HOST=https://cocktails-api.docker.local:7176
      - COSMOS_ACCOUNT_ENDPOINT=https://cosmosdb.docker.local:8081/
      - COSMOS_CONNECTION_STRING=AccountEndpoint=https://cosmosdb.docker.local:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==;
      - COSMOS_CONTAINER_NAME=cezzis-docker-device-auth
      - COSMOS_DATABASE_NAME=cocktails-db
      - LOG_LEVEL=info
      - OTLP_ENDPOINT=https://otel-collector.docker.local:50052
      - OTLP_INSECURE=false
      - OTLP_METRICS_ENABLED=false
      - TLS_CERT_FILE=/certs/docker-local.crt
      - TLS_KEY_FILE=/certs/docker-local.key
    volumes:
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/docker-local}:/certs:ro"
    entrypoint: >
      sh -c "
        if ls /certs/*.crt 1> /dev/null 2>&1; then
          apk add --no-cache ca-certificates &&
          cp /certs/*.crt /usr/local/share/ca-certificates/ &&
          update-ca-certificates
        fi &&
        exec /cezzis-cocktails
      "
    networks:
      cezzis-network:
        aliases:
          - cocktails-mcp.docker.local
      elastic-stack_elastic-network:
      azure-stack_azure-network:

  dapr-sidecar-cocktails-api:
    hostname: dapr-sidecar-cocktails-api.docker.local
    container_name: dapr-sidecar-cocktails-api
    image: daprio/daprd:latest
    restart: unless-stopped
    ports:
      - "3500:3500"
      - "50001:50001"
    environment:
      - SSL_CERT_DIR=/certs
      - OTEL_EXPORTER_OTLP_HEADERS=Authorization=Bearer bd97d99d-f52d-4827-84d5-3760cbc2c8ea
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=docker
      - DAPR_APP_TOKEN=1abf64ac-76bd-4922-ac1d-3732d09a71db
      - APP_API_TOKEN=0d235ec9-161f-4d92-86e2-ed8f907ef465
    command: >
      ./daprd
        --app-id cocktails-api-dapr
        --app-port 7176
        --app-protocol https
        --dapr-http-port 3500
        --dapr-grpc-port 50001
        --resources-path /components
        --config /components/config.yaml
        --enable-metrics false
        --enable-api-logging false
        --placement-host-address ''
        --scheduler-host-address 'dapr-scheduler-cezzis.docker.local:50004'
        --app-channel-address cocktails-api.docker.local
    volumes:
      - ./.dapr/docker:/components
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/azurite-local/azurite-local.crt}:/certs/azurite-local.crt:ro"
      - "${DOCKER_LOCAL_CERT_PATH:-$HOME/Github/dev-certs/docker-local/docker-local.crt}:/certs/docker-local.crt:ro"
    networks:
      cezzis-network:
        aliases:
          - dapr-sidecar-cocktails-api.docker.local
      elastic-stack_elastic-network:
      redis-stack_redis-network:
      azure-stack_azure-network:
      kafka-stack_kafka-network:
    depends_on:
      - dapr-scheduler

  dapr-scheduler:
    hostname: dapr-scheduler-cezzis.docker.local
    container_name: dapr-scheduler-cezzis
    image: daprio/dapr:latest
    command: ["./scheduler", "--port", "50004", "--etcd-data-dir", "/data"]
    ports:
      - "50004:50004"
      - "52378:2379"
    restart: unless-stopped
    networks:
      cezzis-network:
        aliases:
          - dapr-scheduler-cezzis.docker.local
    volumes:
      - vol_scheduler:/data
    user: "0:0"


networks:
  cezzis-network:
    driver: bridge
  
  azure-stack_azure-network:
    external: true
    name: azure-stack_azure-network

  redis-stack_redis-network:
    external: true
    name: redis-stack_redis-network

  kafka-stack_kafka-network:
    external: true
    
  elastic-stack_elastic-network:
    external: true
    name: elastic-stack_elastic-network

volumes:
  vol_scheduler: